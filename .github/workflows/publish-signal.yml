# .github/workflows/publish-signal.yml
name: Publish Signal Module

on:
  push:
    tags:
      - 'v*'          # z.B. v1.0.0, v1.0.1

permissions:
  contents: read

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install PowerShell 7
        run: |
          dotnet tool install --global PowerShell
          echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH

      - name: Install PSResourceGet
        shell: pwsh
        run: |
          Install-Module Microsoft.PowerShell.PSResourceGet -Scope CurrentUser -Force
          Import-Module Microsoft.PowerShell.PSResourceGet

      - name: Build clean artifact
        shell: pwsh
        run: |
          $moduleName = 'signal'
          $srcRoot    = Join-Path $PWD $moduleName
          $outRoot    = Join-Path $PWD 'artifacts'
          $outModule  = Join-Path $outRoot $moduleName

          if (Test-Path $outRoot) { Remove-Item $outRoot -Recurse -Force }
          New-Item -ItemType Directory -Path $outModule -Force | Out-Null

          $include = @('*.psd1','*.psm1','*.ps1','*.ps1xml','README*','LICENSE*')
          $exclude = @('*.Tests.ps1','*.test.ps1', '*.Temp*.ps1')
          Copy-Item -Path (Join-Path $srcRoot '*') -Destination $outModule -Recurse -Include $include -Exclude $exclude -Force

          # optional: Tests & Dev-Kram entfernen
          Get-ChildItem -Path $outModule -Recurse -Include '*.Tests.ps1','*.test.ps1','.git*','.vscode','*.csproj' -ErrorAction SilentlyContinue |
            Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "Build artifact at $outModule"

      - name: Publish to PowerShell Gallery
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        env:
          PSGALLERY_APIKEY: ${{ secrets.PSGALLERY_APIKEY }}
        run: |
          Import-Module Microsoft.PowerShell.PSResourceGet

          $modulePath = Join-Path $PWD 'artifacts\signal'

          # Optional: Manifest testen
          $manifest = Get-ChildItem -Path $modulePath -Filter '*.psd1' | Select-Object -First 1
          if (-not $manifest) {
            Write-Error "Kein Modulmanifest im Build-Ordner gefunden."
            exit 1
          }
          Test-ModuleManifest -Path $manifest.FullName | Out-Null

          Publish-PSResource `
            -Path $modulePath `
            -Repository 'PSGallery' `
            -ApiKey $env:PSGALLERY_APIKEY `
            -Verbose
